# GitHub Actions è‡ªåŠ¨åŒ–çˆ¬å–éƒ¨ç½²æŒ‡å—

æœ¬é¡¹ç›®æ”¯æŒé€šè¿‡GitHub Actionsè¿›è¡Œè‡ªåŠ¨åŒ–çš„å‘¨æœŸæ€§çˆ¬å–ï¼Œæ— éœ€æœ¬åœ°æœåŠ¡å™¨24å°æ—¶è¿è¡Œã€‚

## ğŸš€ å¿«é€Ÿéƒ¨ç½²

### 1. å¯ç”¨GitHub Actions

1. ç¡®ä¿ä½ çš„ä»£ç å·²æ¨é€åˆ°GitHubä»“åº“
2. è¿›å…¥ä»“åº“çš„ `Actions` æ ‡ç­¾é¡µ
3. å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡ä½¿ç”¨ï¼Œç‚¹å‡» `I understand my workflows, go ahead and enable them`

### 2. é…ç½®å·¥ä½œæµ

é¡¹ç›®åŒ…å«ä¸¤ä¸ªé¢„é…ç½®çš„å·¥ä½œæµï¼š

#### åŸºç¡€å·¥ä½œæµ (`gamersky-crawler.yml`)
- âœ… æ¯5åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡
- âœ… æ”¯æŒæ‰‹åŠ¨è§¦å‘
- âœ… è‡ªåŠ¨ä¸Šä¼ çˆ¬å–æ•°æ®

#### çµæ´»å·¥ä½œæµ (`gamersky-flexible.yml`) ğŸŒŸ æ¨è
- âœ… æ™ºèƒ½è°ƒåº¦ï¼šå·¥ä½œæ—¶é—´é«˜é¢‘ï¼Œéå·¥ä½œæ—¶é—´ä½é¢‘
- âœ… å¤šç§æ¨¡å¼ï¼šæ™®é€šæ¨¡å¼ã€æ·±åº¦æ¨¡å¼ã€æµ‹è¯•æ¨¡å¼
- âœ… è‡ªåŠ¨æ¸…ç†ï¼šå®šæœŸåˆ é™¤æ—§æ•°æ®
- âœ… è¯¦ç»†æŠ¥å‘Šï¼šç”Ÿæˆçˆ¬å–ç»Ÿè®¡æŠ¥å‘Š

## ğŸ“‹ å®šæ—¶ç­–ç•¥è¯´æ˜

### çµæ´»å·¥ä½œæµçš„å®šæ—¶ç­–ç•¥

| æ—¶é—´æ®µ | é¢‘ç‡ | é¡µæ•° | è¯´æ˜ |
|--------|------|------|------|
| å·¥ä½œæ—¥ 9:00-18:00 | æ¯10åˆ†é’Ÿ | 3é¡µ | é«˜é¢‘çˆ¬å–ï¼ŒåŠæ—¶è·å–çƒ­ç‚¹æ–°é—» |
| å·¥ä½œæ—¥å…¶ä»–æ—¶é—´ | æ¯30åˆ†é’Ÿ | 2é¡µ | ä¸­é¢‘çˆ¬å–ï¼Œä¿æŒæ•°æ®æ›´æ–° |
| å‘¨æœ«å…¨å¤© | æ¯30åˆ†é’Ÿ | 2é¡µ | ä½é¢‘çˆ¬å–ï¼ŒèŠ‚çœèµ„æº |
| æ¯å¤©å‡Œæ™¨2ç‚¹ | æ¯å¤©1æ¬¡ | 10é¡µ | æ·±åº¦çˆ¬å–ï¼Œè·å–æ›´å¤šå†å²æ•°æ® |

### è‡ªå®šä¹‰å®šæ—¶ç­–ç•¥

ä¿®æ”¹ `.github/workflows/gamersky-flexible.yml` æ–‡ä»¶ä¸­çš„ `schedule` éƒ¨åˆ†ï¼š

```yaml
schedule:
  # æ¯5åˆ†é’Ÿï¼ˆé«˜é¢‘ï¼‰
  - cron: '*/5 * * * *'
  
  # æ¯15åˆ†é’Ÿï¼ˆä¸­é¢‘ï¼‰
  - cron: '*/15 * * * *'
  
  # æ¯å°æ—¶ï¼ˆä½é¢‘ï¼‰
  - cron: '0 * * * *'
  
  # æ¯å¤©8ç‚¹å’Œ20ç‚¹
  - cron: '0 8,20 * * *'
  
  # ä»…å·¥ä½œæ—¥æ‰§è¡Œ
  - cron: '0 9 * * 1-5'
```

## ğŸ® æ‰‹åŠ¨æ‰§è¡Œ

### é€šè¿‡GitHubç½‘é¡µç•Œé¢

1. è¿›å…¥ä»“åº“çš„ `Actions` æ ‡ç­¾é¡µ
2. é€‰æ‹© `Gamersky News Crawler (Flexible Schedule)`
3. ç‚¹å‡»å³ä¾§çš„ `Run workflow` æŒ‰é’®
4. é€‰æ‹©å‚æ•°ï¼š
   - **çˆ¬å–æ¨¡å¼**: `normal`ï¼ˆ3é¡µï¼‰ã€`deep`ï¼ˆ10é¡µï¼‰ã€`test`ï¼ˆ1é¡µï¼‰
   - **çˆ¬å–é¡µæ•°**: å¯ä»¥è¦†ç›–é»˜è®¤é¡µæ•°
   - **è¯·æ±‚å»¶è¿Ÿ**: å¦‚ `1s`ã€`2s`ã€`500ms`

### é€šè¿‡GitHub CLI

```bash
# å®‰è£… GitHub CLI
gh auth login

# æ‰‹åŠ¨è§¦å‘æ™®é€šæ¨¡å¼
gh workflow run "gamersky-flexible.yml" \
  --field crawl_mode=normal \
  --field pages=3 \
  --field delay=1s

# æ‰‹åŠ¨è§¦å‘æ·±åº¦æ¨¡å¼
gh workflow run "gamersky-flexible.yml" \
  --field crawl_mode=deep \
  --field pages=10 \
  --field delay=2s
```

## ğŸ“Š æ•°æ®ç®¡ç†

### æŸ¥çœ‹çˆ¬å–ç»“æœ

1. è¿›å…¥ `Actions` æ ‡ç­¾é¡µ
2. ç‚¹å‡»ä»»æ„ä¸€æ¬¡è¿è¡Œè®°å½•
3. åœ¨é¡µé¢åº•éƒ¨æ‰¾åˆ° `Artifacts` éƒ¨åˆ†
4. ä¸‹è½½ `gamersky-xxx-xxx` å‹ç¼©åŒ…
5. è§£å‹åè·å¾— SQLite æ•°æ®åº“æ–‡ä»¶å’ŒæŠ¥å‘Š

### æ•°æ®æ–‡ä»¶è¯´æ˜

```
gamersky-normal-123.zip
â”œâ”€â”€ gamersky_normal_20240918_143022.db  # SQLiteæ•°æ®åº“
â””â”€â”€ crawl_report.txt                    # çˆ¬å–æŠ¥å‘Š
```

### è‡ªåŠ¨æ¸…ç†ç­–ç•¥

- **Artifactsä¿ç•™æœŸ**: 30å¤©è‡ªåŠ¨åˆ é™¤
- **æ—§æ•°æ®æ¸…ç†**: æ¯æ¬¡å®šæ—¶ä»»åŠ¡ä¼šæ¸…ç†7å¤©å‰çš„artifacts
- **å­˜å‚¨é™åˆ¶**: GitHubå…è´¹è´¦æˆ·æœ‰å­˜å‚¨é…é¢é™åˆ¶

## âš™ï¸ é«˜çº§é…ç½®

### 1. è®¾ç½®Secretsï¼ˆæ•æ„Ÿä¿¡æ¯ï¼‰

å¦‚æœéœ€è¦é…ç½®æ•°æ®åº“è¿æ¥ã€APIå¯†é’¥ç­‰ï¼š

1. è¿›å…¥ä»“åº“ `Settings` > `Secrets and variables` > `Actions`
2. ç‚¹å‡» `New repository secret`
3. æ·»åŠ æ‰€éœ€çš„ç¯å¢ƒå˜é‡

```yaml
# åœ¨å·¥ä½œæµä¸­ä½¿ç”¨
env:
  DATABASE_URL: ${{ secrets.DATABASE_URL }}
  API_KEY: ${{ secrets.API_KEY }}
```

### 2. é…ç½®é€šçŸ¥

#### ä¼ä¸šå¾®ä¿¡é€šçŸ¥ç¤ºä¾‹

```yaml
- name: å‘é€ä¼ä¸šå¾®ä¿¡é€šçŸ¥
  if: success()
  run: |
    curl -X POST "${{ secrets.WECHAT_WEBHOOK }}" \
      -H "Content-Type: application/json" \
      -d '{
        "msgtype": "text",
        "text": {
          "content": "âœ… Gamerskyçˆ¬å–æˆåŠŸ\næ—¶é—´: $(date)\né¡µæ•°: ${{ needs.determine-params.outputs.pages }}"
        }
      }'
```

#### é‚®ä»¶é€šçŸ¥ç¤ºä¾‹

```yaml
- name: å‘é€é‚®ä»¶é€šçŸ¥
  uses: dawidd6/action-send-mail@v3
  with:
    server_address: smtp.gmail.com
    server_port: 587
    username: ${{ secrets.EMAIL_USERNAME }}
    password: ${{ secrets.EMAIL_PASSWORD }}
    subject: "Gamerskyçˆ¬å–æŠ¥å‘Š"
    body: file://crawl_report.txt
    to: your-email@example.com
```

### 3. æ•°æ®åŒæ­¥åˆ°å¤–éƒ¨å­˜å‚¨

#### åŒæ­¥åˆ°é˜¿é‡Œäº‘OSS

```yaml
- name: åŒæ­¥åˆ°é˜¿é‡Œäº‘OSS
  env:
    OSS_ACCESS_KEY_ID: ${{ secrets.OSS_ACCESS_KEY_ID }}
    OSS_ACCESS_KEY_SECRET: ${{ secrets.OSS_ACCESS_KEY_SECRET }}
  run: |
    # å®‰è£…ossutil
    wget https://gosspublic.alicdn.com/ossutil/1.7.15/ossutil64
    chmod +x ossutil64
    
    # é…ç½®OSS
    ./ossutil64 config -e oss-cn-beijing.aliyuncs.com \
      -i $OSS_ACCESS_KEY_ID \
      -k $OSS_ACCESS_KEY_SECRET
    
    # ä¸Šä¼ æ•°æ®
    ./ossutil64 cp data/ oss://your-bucket/gamersky/ -r
```

## ğŸ› ï¸ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **å·¥ä½œæµä¸æ‰§è¡Œ**
   - æ£€æŸ¥ä»“åº“æ˜¯å¦å¯ç”¨äº†Actions
   - ç¡®è®¤cronè¡¨è¾¾å¼æ ¼å¼æ­£ç¡®
   - æ£€æŸ¥ä»“åº“æ˜¯å¦æœ‰æœ€è¿‘çš„æ´»åŠ¨ï¼ˆGitHubå¯èƒ½æš‚åœä¸æ´»è·ƒä»“åº“çš„å®šæ—¶ä»»åŠ¡ï¼‰

2. **çˆ¬å–å¤±è´¥**
   - æŸ¥çœ‹Actionsè¿è¡Œæ—¥å¿—
   - æ£€æŸ¥ç½‘ç»œè¿æ¥é—®é¢˜
   - ç¡®è®¤ç›®æ ‡ç½‘ç«™æ˜¯å¦å¯è®¿é—®

3. **å­˜å‚¨ç©ºé—´ä¸è¶³**
   - æ£€æŸ¥GitHubå­˜å‚¨é…é¢
   - è°ƒæ•´æ•°æ®ä¿ç•™ç­–ç•¥
   - è€ƒè™‘åŒæ­¥åˆ°å¤–éƒ¨å­˜å‚¨

### è°ƒè¯•æŠ€å·§

1. **å¯ç”¨è¯¦ç»†æ—¥å¿—**
   ```yaml
   env:
     ACTIONS_RUNNER_DEBUG: true
     ACTIONS_STEP_DEBUG: true
   ```

2. **æµ‹è¯•æ¨¡å¼è¿è¡Œ**
   ```bash
   # æ‰‹åŠ¨è§¦å‘æµ‹è¯•æ¨¡å¼
   gh workflow run "gamersky-flexible.yml" --field crawl_mode=test
   ```

3. **æœ¬åœ°æµ‹è¯•**
   ```bash
   # æœ¬åœ°æµ‹è¯•å•æ¬¡æ‰§è¡Œå‘½ä»¤
   CGO_ENABLED=1 go run main.go gamersky-once --pages=1
   ```

## ğŸ“ˆ ç›‘æ§å’Œä¼˜åŒ–

### æ€§èƒ½ç›‘æ§

åœ¨å·¥ä½œæµä¸­æ·»åŠ æ€§èƒ½ç›‘æ§ï¼š

```yaml
- name: æ€§èƒ½ç›‘æ§
  run: |
    echo "=== ç³»ç»Ÿèµ„æºä½¿ç”¨æƒ…å†µ ==="
    df -h
    free -h
    echo "=== çˆ¬å–ä»»åŠ¡èµ„æºä½¿ç”¨ ==="
    time go run main.go gamersky-once --pages=1
```

### æˆæœ¬ä¼˜åŒ–

1. **è°ƒæ•´æ‰§è¡Œé¢‘ç‡**: æ ¹æ®éœ€æ±‚é™ä½æ‰§è¡Œé¢‘ç‡
2. **ä½¿ç”¨æ¡ä»¶æ‰§è¡Œ**: ä»…åœ¨æœ‰æ–°å†…å®¹æ—¶æ‰§è¡Œ
3. **ä¼˜åŒ–æ•°æ®å­˜å‚¨**: å‹ç¼©æ•°æ®åº“ï¼Œåˆ é™¤é‡å¤å†…å®¹

## ğŸ”„ å‡çº§å’Œç»´æŠ¤

### ä¾èµ–æ›´æ–°

```yaml
# æ·»åŠ ä¾èµ–æ›´æ–°æ£€æŸ¥
- name: æ£€æŸ¥Goæ¨¡å—æ›´æ–°
  run: |
    go list -u -m all
    go mod tidy
```

### å®šæœŸç»´æŠ¤ä»»åŠ¡

```yaml
# æ¯å‘¨è¿è¡Œç»´æŠ¤ä»»åŠ¡
schedule:
  - cron: '0 0 * * 0'  # æ¯å‘¨æ—¥åˆå¤œ

jobs:
  maintenance:
    runs-on: ubuntu-latest
    steps:
    - name: æ•°æ®åº“ä¼˜åŒ–
      run: |
        # æ•°æ®åº“VACUUMï¼Œå»é‡ç­‰æ“ä½œ
        sqlite3 data/gamersky.db "VACUUM;"
```

é€šè¿‡ä»¥ä¸Šé…ç½®ï¼Œä½ çš„GitHub Actionsçˆ¬è™«å°†èƒ½å¤Ÿï¼š
- ğŸ”„ è‡ªåŠ¨åŒ–å‘¨æœŸæ€§æ‰§è¡Œ
- ğŸ“Š ç”Ÿæˆè¯¦ç»†çš„çˆ¬å–æŠ¥å‘Š  
- ğŸ’¾ å®‰å…¨å­˜å‚¨å’Œç®¡ç†æ•°æ®
- ğŸ”” åŠæ—¶é€šçŸ¥çˆ¬å–çŠ¶æ€
- ğŸ› ï¸ ä¾¿äºè°ƒè¯•å’Œç»´æŠ¤

ç°åœ¨ä½ å¯ä»¥äº«å—å®Œå…¨è‡ªåŠ¨åŒ–çš„æ–°é—»çˆ¬å–æœåŠ¡äº†ï¼