name: Gamersky News and Comments Crawler

on:
  # å®šæ—¶è§¦å‘ - æ¯5åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡
  schedule:
    # - cron: '*/5 * * * *'  # æ¯5åˆ†é’Ÿ
    - cron: '*/20 * * * *'  # æ¯15åˆ†é’Ÿ
    # - cron: '*/30 * * * *'  # æ¯30åˆ†é’Ÿ
    # - cron: '0 * * * *'     # æ¯å°æ—¶
    # - cron: '0 */2 * * *'   # æ¯2å°æ—¶
    # - cron: '0 0 */6 * *'   # æ¯6å°æ—¶
    
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      news_pages:
        description: 'çˆ¬å–æ–°é—»é¡µæ•°'
        required: false
        default: '2'
        type: string
      comment_pages:
        description: 'æ¯æ¡æ–°é—»çˆ¬å–çš„è¯„è®ºé¡µæ•°'
        required: false
        default: '5'
        type: string
      delay:
        description: 'è¯·æ±‚å»¶è¿Ÿæ—¶é—´ (å¦‚: 1s, 2s, 500ms)'
        required: false
        default: '2s'
        type: string

  # æ¨é€è§¦å‘ï¼ˆå¯é€‰ï¼‰
  # push:
  #   branches: [ main, master ]

env:
  # è®¾ç½®æ—¶åŒº
  TZ: Asia/Shanghai

# æ·»åŠ æƒé™é…ç½®
permissions:
  contents: write  # å…è®¸å†™å…¥ä»“åº“å†…å®¹
  actions: read   # å…è®¸è¯»å–actions

jobs:
  crawl:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½® Go ç¯å¢ƒ
      uses: actions/setup-go@v4
      with:
        go-version: '1.21'
        
    - name: ç¼“å­˜ Go æ¨¡å—
      uses: actions/cache@v3
      with:
        path: |
          ~/.cache/go-build
          ~/go/pkg/mod
        key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-go-

    - name: ä¸‹è½½ä¾èµ–
      run: go mod download
      
    - name: åˆ›å»ºæ•°æ®ç›®å½•
      run: mkdir -p data/ci-output
      
    - name: æ‰§è¡Œçˆ¬å–ä»»åŠ¡
      env:
        CGO_ENABLED: 1
      run: |
        # æ ¹æ®è§¦å‘æ–¹å¼è®¾ç½®å‚æ•°
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          # æ‰‹åŠ¨è§¦å‘ï¼Œä½¿ç”¨è¾“å…¥å‚æ•°
          NEWS_PAGES="${{ github.event.inputs.news_pages }}"
          COMMENT_PAGES="${{ github.event.inputs.comment_pages }}"
          DELAY="${{ github.event.inputs.delay }}"
        else
          # å®šæ—¶è§¦å‘ï¼Œä½¿ç”¨é»˜è®¤å‚æ•°
          NEWS_PAGES="2"
          COMMENT_PAGES="3"
          DELAY="1s"
        fi

        echo "å¼€å§‹çˆ¬å– Gamersky æ–°é—»å’Œè¯„è®º..."
        echo "æ–°é—»é¡µæ•°: $NEWS_PAGES"
        echo "è¯„è®ºé¡µæ•°: $COMMENT_PAGES"
        echo "å»¶è¿Ÿ: $DELAY"
        echo "æ—¶é—´: $(date)"

        # ç”Ÿæˆä¸€æ¬¡æ€§æ—¶é—´æˆ³ï¼Œå†™å…¥ GITHUB_ENV ä»¥ä¾¿åç»­æ­¥éª¤å¤ç”¨ï¼Œä¿è¯æœ¬æ¬¡ run ä½¿ç”¨ç›¸åŒæ—¶é—´
        RUN_TS=$(date +%Y%m%d_%H%M%S)
        echo "RUN_TS=$RUN_TS" >> "$GITHUB_ENV"

        # æ‰§è¡Œçˆ¬å–å‘½ä»¤ï¼ˆä½¿ç”¨æå‰è·å–çš„æ—¶é—´æˆ³ï¼‰
        go run main.go gamersky-full \
          --news-pages="$NEWS_PAGES" \
          --comment-pages="$COMMENT_PAGES" \
          --delay="$DELAY" \
          --output="./data/ci-output/gamersky_${RUN_TS}.db"
          
    - name: æ£€æŸ¥çˆ¬å–ç»“æœ
      run: |
        echo "=== çˆ¬å–ç»“æœç»Ÿè®¡ ==="
        if ls data/ci-output/*.db 1> /dev/null 2>&1; then
          for db in data/ci-output/*.db; do
            echo "æ•°æ®åº“æ–‡ä»¶: $db"
            echo "æ–‡ä»¶å¤§å°: $(du -h "$db" | cut -f1)"
            
            # å¦‚æœæœ‰sqlite3å‘½ä»¤ï¼Œæ˜¾ç¤ºè®°å½•æ•°
            if command -v sqlite3 &> /dev/null; then
              echo "æ–°é—»æ•°é‡: $(sqlite3 "$db" "SELECT COUNT(*) FROM gamersky_news;" 2>/dev/null || echo "æ— æ³•æŸ¥è¯¢")"
              echo "è¯„è®ºæ•°é‡: $(sqlite3 "$db" "SELECT COUNT(*) FROM gamersky_comments;" 2>/dev/null || echo "æ— æ³•æŸ¥è¯¢")"
              echo "æ€»è®°å½•æ•°: $(sqlite3 "$db" "SELECT (SELECT COUNT(*) FROM gamersky_news) + (SELECT COUNT(*) FROM gamersky_comments);" 2>/dev/null || echo "æ— æ³•æŸ¥è¯¢")"
            fi
            echo "---"
          done
        else
          echo "æœªæ‰¾åˆ°æ•°æ®åº“æ–‡ä»¶"
        fi
        
    - name: ä¸Šä¼ çˆ¬å–æ•°æ®
      uses: actions/upload-artifact@v4
      if: always()  # å³ä½¿å‰é¢æ­¥éª¤å¤±è´¥ä¹Ÿè¦ä¸Šä¼ 
      with:
        name: gamersky-data-${{ github.run_number }}
        path: |
          data/ci-output/*.db
          data/ci-output/*.log
        retention-days: 30  # ä¿ç•™30å¤©
        
    # - name: æäº¤æ•°æ®åˆ°ä»“åº“ (å¯é€‰)
    #   if: github.event_name == 'schedule'  # ä»…å®šæ—¶ä»»åŠ¡æäº¤
    #   run: |
    #     # é…ç½® git
    #     git config --local user.email "action@github.com"
    #     git config --local user.name "GitHub Action"
    #     
    #     # æ£€æŸ¥æ˜¯å¦æœ‰å˜åŒ–
    #     if [ -n "$(git status --porcelain data/)" ]; then
    #       echo "å‘ç°æ–°æ•°æ®ï¼Œæäº¤åˆ°ä»“åº“..."
    #       git add data/
    #       git commit -m "ğŸ¤– è‡ªåŠ¨çˆ¬å– Gamersky æ–°é—»æ•°æ® - $(date '+%Y-%m-%d %H:%M:%S')"
    #       git push
    #     else
    #       echo "æ²¡æœ‰æ–°æ•°æ®å˜åŒ–"
    #     fi

  # å¯é€‰ï¼šå‘é€é€šçŸ¥ä»»åŠ¡
  notify:
    runs-on: ubuntu-latest
    needs: crawl
    if: failure()  # ä»…åœ¨çˆ¬å–å¤±è´¥æ—¶è¿è¡Œ
    
    steps:
    - name: å‘é€å¤±è´¥é€šçŸ¥
      run: |
        echo "Gamersky çˆ¬å–ä»»åŠ¡å¤±è´¥ï¼"
        echo "æ—¶é—´: $(date)"
        echo "è¿è¡ŒID: ${{ github.run_id }}"
        # è¿™é‡Œå¯ä»¥é›†æˆä¼ä¸šå¾®ä¿¡ã€é’‰é’‰ã€Slackç­‰é€šçŸ¥æœåŠ¡
        # curl -X POST "your-webhook-url" -d "{"text":"çˆ¬å–ä»»åŠ¡å¤±è´¥"}"
