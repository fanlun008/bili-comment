name: Gamersky News Crawler (Flexible Schedule)

on:
  # å¤šç§å®šæ—¶ç­–ç•¥
  # schedule:
  #   # é«˜é¢‘çˆ¬å– - æ¯10åˆ†é’Ÿ (å·¥ä½œæ—¶é—´)
  #   - cron: '*/10 9-18 * * 1-5'  # å·¥ä½œæ—¥ 9:00-18:00ï¼Œæ¯10åˆ†é’Ÿ
    
  #   # ä¸­é¢‘çˆ¬å– - æ¯30åˆ†é’Ÿ (éå·¥ä½œæ—¶é—´)
  #   - cron: '*/30 0-8,19-23 * * 1-5'  # å·¥ä½œæ—¥å…¶ä»–æ—¶é—´ï¼Œæ¯30åˆ†é’Ÿ
  #   - cron: '*/30 * * * 0,6'  # å‘¨æœ«ï¼Œæ¯30åˆ†é’Ÿ
    
  #   # æ·±åº¦çˆ¬å– - æ¯å¤©å‡Œæ™¨ (çˆ¬å–æ›´å¤šé¡µé¢)
  #   - cron: '0 2 * * *'  # æ¯å¤©å‡Œæ™¨2ç‚¹ï¼Œæ·±åº¦çˆ¬å–
    
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      crawl_mode:
        description: 'çˆ¬å–æ¨¡å¼'
        required: true
        default: 'normal'
        type: choice
        options:
        - normal
        - deep
        - test
      pages:
        description: 'çˆ¬å–é¡µæ•° (normal: 3, deep: 10, test: 1)'
        required: false
        default: 'auto'
        type: string
      delay:
        description: 'è¯·æ±‚å»¶è¿Ÿæ—¶é—´'
        required: false
        default: '1s'
        type: string

env:
  TZ: Asia/Shanghai

jobs:
  determine-params:
    runs-on: ubuntu-latest
    outputs:
      pages: ${{ steps.set-params.outputs.pages }}
      delay: ${{ steps.set-params.outputs.delay }}
      mode: ${{ steps.set-params.outputs.mode }}
    
    steps:
    - name: ç¡®å®šçˆ¬å–å‚æ•°
      id: set-params
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          # æ‰‹åŠ¨è§¦å‘
          MODE="${{ github.event.inputs.crawl_mode }}"
          DELAY="${{ github.event.inputs.delay }}"
          
          if [ "${{ github.event.inputs.pages }}" = "auto" ]; then
            case "$MODE" in
              "normal") PAGES="3" ;;
              "deep") PAGES="10" ;;
              "test") PAGES="1" ;;
              *) PAGES="3" ;;
            esac
          else
            PAGES="${{ github.event.inputs.pages }}"
          fi
        else
          # å®šæ—¶è§¦å‘ï¼Œæ ¹æ®æ—¶é—´åˆ¤æ–­æ¨¡å¼
          HOUR=$(date +%H)
          DAY_OF_WEEK=$(date +%u)  # 1-7 (Monday-Sunday)
          
          if [ "$HOUR" = "02" ]; then
            # å‡Œæ™¨2ç‚¹ - æ·±åº¦çˆ¬å–
            MODE="deep"
            PAGES="10"
            DELAY="2s"
          elif [ "$DAY_OF_WEEK" -ge 1 ] && [ "$DAY_OF_WEEK" -le 5 ] && [ "$HOUR" -ge 9 ] && [ "$HOUR" -le 18 ]; then
            # å·¥ä½œæ—¥å·¥ä½œæ—¶é—´ - é«˜é¢‘çˆ¬å–
            MODE="normal"
            PAGES="3"
            DELAY="1s"
          else
            # å…¶ä»–æ—¶é—´ - æ™®é€šçˆ¬å–
            MODE="normal"
            PAGES="2"
            DELAY="1s"
          fi
        fi
        
        echo "pages=$PAGES" >> $GITHUB_OUTPUT
        echo "delay=$DELAY" >> $GITHUB_OUTPUT
        echo "mode=$MODE" >> $GITHUB_OUTPUT
        
        echo "çˆ¬å–æ¨¡å¼: $MODE"
        echo "çˆ¬å–é¡µæ•°: $PAGES"
        echo "è¯·æ±‚å»¶è¿Ÿ: $DELAY"

  crawl:
    runs-on: ubuntu-latest
    needs: determine-params
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½® Go ç¯å¢ƒ
      uses: actions/setup-go@v4
      with:
        go-version: '1.21'
        
    - name: ç¼“å­˜ Go æ¨¡å—
      uses: actions/cache@v3
      with:
        path: |
          ~/.cache/go-build
          ~/go/pkg/mod
        key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-go-

    - name: ä¸‹è½½ä¾èµ–
      run: go mod download
      
    - name: åˆ›å»ºæ•°æ®ç›®å½•
      run: mkdir -p data
      
    - name: æ‰§è¡Œçˆ¬å–ä»»åŠ¡
      env:
        CGO_ENABLED: 1
      run: |
        TIMESTAMP=$(date +%Y%m%d_%H%M%S)
        MODE="${{ needs.determine-params.outputs.mode }}"
        PAGES="${{ needs.determine-params.outputs.pages }}"
        DELAY="${{ needs.determine-params.outputs.delay }}"
        
        echo "========================================="
        echo "ğŸš€ å¼€å§‹ Gamersky æ–°é—»çˆ¬å–ä»»åŠ¡"
        echo "========================================="
        echo "ğŸ“… æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
        echo "ğŸ”§ æ¨¡å¼: $MODE"
        echo "ğŸ“„ é¡µæ•°: $PAGES"
        echo "â±ï¸  å»¶è¿Ÿ: $DELAY"
        echo "ğŸ¯ è§¦å‘: ${{ github.event_name }}"
        echo "========================================="
        
        # æ‰§è¡Œçˆ¬å–
        OUTPUT_DB="./data/gamersky_${MODE}_${TIMESTAMP}.db"
        
        go run main.go gamersky-once \
          --pages="$PAGES" \
          --delay="$DELAY" \
          --output="$OUTPUT_DB"
          
        echo "âœ… çˆ¬å–å®Œæˆï¼Œæ•°æ®ä¿å­˜åˆ°: $OUTPUT_DB"
        
    - name: ç”Ÿæˆçˆ¬å–æŠ¥å‘Š
      run: |
        echo "=== ğŸ“Š çˆ¬å–ç»“æœæŠ¥å‘Š ===" > crawl_report.txt
        echo "æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')" >> crawl_report.txt
        echo "æ¨¡å¼: ${{ needs.determine-params.outputs.mode }}" >> crawl_report.txt
        echo "é¡µæ•°: ${{ needs.determine-params.outputs.pages }}" >> crawl_report.txt
        echo "å»¶è¿Ÿ: ${{ needs.determine-params.outputs.delay }}" >> crawl_report.txt
        echo "è§¦å‘æ–¹å¼: ${{ github.event_name }}" >> crawl_report.txt
        echo "" >> crawl_report.txt
        
        if ls data/*.db 1> /dev/null 2>&1; then
          echo "ğŸ“ ç”Ÿæˆçš„æ•°æ®æ–‡ä»¶:" >> crawl_report.txt
          for db in data/*.db; do
            echo "  - $(basename "$db"): $(du -h "$db" | cut -f1)" >> crawl_report.txt
          done
        else
          echo "âŒ æœªæ‰¾åˆ°æ•°æ®åº“æ–‡ä»¶" >> crawl_report.txt
        fi
        
        echo "" >> crawl_report.txt
        echo "ğŸ”— GitHub Actions è¿è¡Œé“¾æ¥:" >> crawl_report.txt
        echo "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> crawl_report.txt
        
        # è¾“å‡ºæŠ¥å‘Šå†…å®¹
        cat crawl_report.txt
        
    - name: ä¸Šä¼ æ•°æ®å’ŒæŠ¥å‘Š
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: gamersky-${{ needs.determine-params.outputs.mode }}-${{ github.run_number }}
        path: |
          data/*.db
          crawl_report.txt
        retention-days: 30

  # æ¸…ç†æ—§æ•°æ® (å¯é€‰)
  cleanup:
    runs-on: ubuntu-latest
    needs: crawl
    if: github.event_name == 'schedule'  # ä»…å®šæ—¶ä»»åŠ¡æ‰§è¡Œæ¸…ç†
    
    steps:
    - name: æ¸…ç†æ—§çš„ Artifacts
      uses: actions/github-script@v6
      with:
        script: |
          const { data: artifacts } = await github.rest.actions.listArtifactsForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            per_page: 100
          });
          
          // åˆ é™¤7å¤©å‰çš„artifacts
          const cutoffDate = new Date();
          cutoffDate.setDate(cutoffDate.getDate() - 7);
          
          for (const artifact of artifacts.artifacts) {
            const createdAt = new Date(artifact.created_at);
            if (createdAt < cutoffDate && artifact.name.startsWith('gamersky-')) {
              console.log(`åˆ é™¤æ—§artifact: ${artifact.name} (${artifact.created_at})`);
              await github.rest.actions.deleteArtifact({
                owner: context.repo.owner,
                repo: context.repo.repo,
                artifact_id: artifact.id
              });
            }
          }
